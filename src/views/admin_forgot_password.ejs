<!DOCTYPE html>
<html lang=grid;">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="/style/general_styles.css" />
    <link rel="stylesheet" href="/style/admin_forgot_password.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GNW | Admin Reset Password</title>
  </head>
  <body>
    <!-- Alert Message Area -->
    

    <div class="container">
      <div id="alertMessage"></div>
      <!-- Step 1: Reset button -->
      <div class="first-step">
        <p>Click the button below to reset your password</p>
      <form id="sendCodeForm">
        <button type="button" id="sendCodeButton" class="transparent-button">Send Reset Code</button>
      </form>
      <a href="/login">back</a>
      </div>

      <!-- Step 2: Enter validation code -->
      <div class="second-step" id="codeInputSection">
        <p>Enter the code sent to your email:</p>
        <div class="inp-button-container">
          <input
          type="text"
          id="codeInput"
          maxlength="6"
          placeholder="Enter Code"
        />  
        <button class="transparent-button" id="validateCodeButton">Validate Code</button>
        </div>
      </div>

      <!-- Step 3: Enter new password -->
      <div class="third-step" id="passwordInputSection">
        <p>Enter your new password:</p>
        <form
          id="resetPasswordForm"
          action="/admin/reset-password"
          method="post"
          onsubmit="validatePassword(event)"
          class="inp-button-container"
        >
          <input type="hidden" name="token" id="hiddenToken" />
          <input
            type="password"
            id="password"
            name="newPassword"
            placeholder="New Password"
            required
          />
          <div id="validationMessage"></div>
          <button type="submit" class="transparent-button">Reset Password</button>
        </form>
      </div>
    </div>
    <script>
      const alertMessageDiv = document.getElementById("alertMessage");
const sendCodeButton = document.getElementById("sendCodeButton");
const codeInputSection = document.getElementById("codeInputSection");
const passwordInputSection = document.getElementById("passwordInputSection");
const validateCodeButton = document.getElementById("validateCodeButton");
const codeInput = document.getElementById("codeInput");
const validationMessage = document.getElementById("validationMessage");

const firstStep = document.querySelector(".first-step");
const secondStep = document.querySelector(".second-step");
const thirdStep = document.querySelector(".third-step");

let receivedCode = ""; // Store the received verification code

// Helper function to display messages
function showAlertMessage(message, isError = false) {
  alertMessageDiv.textContent = message;
  alertMessageDiv.style.color = isError ? "red" : "blue";
}

// Function to hide current step and show the next step with transition
function proceedToNextStep(currentStep, nextStep) {
  currentStep.classList.add("hidden");
  setTimeout(() => {
    currentStep.style.display = "none"; // Ensure it's removed from the flow
    nextStep.style.display = "block"; // Show the next step
    nextStep.classList.remove("hidden"); // Animate the appearance
  }, 500); // Match the transition duration
}

// Step 1: Trigger sending the code
sendCodeButton.addEventListener("click", async () => {
  try {
    const response = await fetch("/admin/send-confirmation-link", {
      method: "POST",
    });

    if (response.ok) {
      const data = await response.json();
      receivedCode = data.verificationCode; // Store the code from the backend
      showAlertMessage("Verification code sent to your email.");
      proceedToNextStep(firstStep, secondStep);
    } else {
      const error = await response.json();
      showAlertMessage(error.error || "Failed to send verification code.", true);
    }
  } catch (error) {
    console.error("Error sending verification code:", error);
    showAlertMessage("An unexpected error occurred. Please try again.", true);
  }
});

// Step 2: Validate the entered code
validateCodeButton.addEventListener("click", () => {
  const enteredCode = codeInput.value.trim();

  if (!/^\d{6}$/.test(enteredCode)) {
    showAlertMessage("Please enter a valid 6-digit numeric code.", true);
    return;
  }

  if (enteredCode === receivedCode) {
    showAlertMessage("Code validated successfully.");
    proceedToNextStep(secondStep, thirdStep);
  } else {
    showAlertMessage("Invalid code. Please try again.", true);
  }
});

// Step 3: Validate the new password
function validatePassword(event) {
  const password = document.getElementById("password").value;

  validationMessage.textContent = "";

  if (password.length < 6 || password.length > 17) {
    event.preventDefault();
    validationMessage.textContent =
      "Password must be between 6 and 17 characters.";
  }
}

    </script>
  </body>
</html>
